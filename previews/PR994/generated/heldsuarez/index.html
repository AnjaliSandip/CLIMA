<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>HS · CLIMA</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="CLIMA logo"/></a><div class="docs-package-name"><span class="docs-autofit">CLIMA</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Common</span><ul><li><a class="tocitem" href="../../Common/MoistThermodynamics/">MoistThermodynamics</a></li><li><a class="tocitem" href="../../Common/SurfaceFluxes/">SurfaceFluxes</a></li></ul></li><li><span class="tocitem">Utilites</span></li><li><span class="tocitem">Atmos</span><ul><li><a class="tocitem" href="../../Atmos/EDMFEquations/">EDMF Equations</a></li><li><a class="tocitem" href="../../Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../Atmos/Model/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../Atmos/Model/turbulence/">Turbulence</a></li><li><a class="tocitem" href="../../Atmos/Model/tracers/">Tracers</a></li></ul></li><li><a class="tocitem" href="../../Diagnostics/">Diagnostics</a></li><li><span class="tocitem">Numerics</span><ul><li><a class="tocitem" href="../../Numerics/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../Numerics/LinearSolvers/">LinearSolvers</a></li><li><a class="tocitem" href="../../Numerics/Mesh/">Mesh</a></li><li><a class="tocitem" href="../../Numerics/Arrays/">Arrays</a></li><li><a class="tocitem" href="../../Numerics/DGmethods_old/">DGmethods_old</a></li></ul></li><li><a class="tocitem" href="../../InputOutput/">InputOutput</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../example_cg/">Conjugate Gradient</a></li><li><a class="tocitem" href="../literate_markdown/">Notes on Literate</a></li><li class="is-active"><a class="tocitem" href>HS</a><ul class="internal"><li><a class="tocitem" href="#Setup-model-configuration-1"><span>Setup model configuration</span></a></li><li><a class="tocitem" href="#Set-initial-condition.-1"><span>Set initial condition.</span></a></li><li><a class="tocitem" href="#Setup-diagnostic-output-1"><span>Setup diagnostic output</span></a></li><li><a class="tocitem" href="#Set-up-and-run-the-simulation-1"><span>Set up and run the simulation</span></a></li><li><a class="tocitem" href="#Visualize-(nc-files-in-julia?)-1"><span>Visualize (nc files in julia?)</span></a></li><li><a class="tocitem" href="#References-1"><span>References</span></a></li></ul></li></ul></li><li><span class="tocitem">Developer docs</span><ul><li><input class="collapse-toggle" id="menuitem-9-1" type="checkbox"/><label class="tocitem" for="menuitem-9-1"><span class="docs-label">Contribution Guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../ContributionGuides/CONTRIBUTING/">Contributing</a></li><li><a class="tocitem" href="../../ContributionGuides/IterativeSolvers/">Contribution Guide for Abstract Iterative Solvers</a></li></ul></li><li><a class="tocitem" href="../../CodingConventions/">Coding Conventions</a></li><li><a class="tocitem" href="../../AcceptableUnicode/">Acceptable Unicode characters</a></li><li><a class="tocitem" href="../../VariableList/">CliMA Variable List</a></li><li><a class="tocitem" href="../../DiagnosticVariables/">CliMA Diagnostic Variable List</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>HS</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>HS</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/climate-machine/CLIMA/blob/master/literate_examples/heldsuarez.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Dry-atmosphere-GCM-with-Held-Suarez-forcing-1"><a class="docs-heading-anchor" href="#Dry-atmosphere-GCM-with-Held-Suarez-forcing-1">Dry atmosphere GCM with Held-Suarez forcing</a><a class="docs-heading-anchor-permalink" href="#Dry-atmosphere-GCM-with-Held-Suarez-forcing-1" title="Permalink"></a></h1><p>The Held-Suarez setup (Held and Suarez, 1994) is a textbook example for a simplified atmospheric global circulation model configuration which has been used as a benchmark experiment for development of the dynamical cores (i.e. GCM without continents, moisture or parametrisation schemes of the physics) for atmospheric models. It is forced by a thermal relaxation to a reference state and damped by linear (Rayleigh) friction.This example demonstrates how</p><ul><li>to set up a CLIMA-Atmos GCM configuration;</li><li>to select and save GCM diagnostics output.</li></ul><p>To begin, we load CLIMA and a few miscellaneous useful Julia packages.</p><pre><code class="language-julia">using Distributions
using LinearAlgebra
using Random
using StaticArrays
#using Test</code></pre><p>CLIMA specific imports</p><pre><code class="language-julia">using CLIMA
using CLIMA.Atmos
using CLIMA.ConfigTypes
using CLIMA.Diagnostics
using CLIMA.GenericCallbacks
using CLIMA.ODESolvers
using CLIMA.ColumnwiseLUSolver: ManyColumnLU
using CLIMA.Mesh.Filters
using CLIMA.Mesh.Grids
using CLIMA.MoistThermodynamics: air_temperature, internal_energy, air_pressure
using CLIMA.VariableTemplates</code></pre><p>CLIMA parameters</p><pre><code class="language-julia">using CLIMAParameters
using CLIMAParameters.Planet: R_d, day, grav, cp_d, cv_d, planet_radius
struct EarthParameterSet &lt;: AbstractEarthParameterSet end
const param_set = EarthParameterSet()</code></pre><pre><code class="language-none">Main.ex-heldsuarez.EarthParameterSet()</code></pre><h2 id="Setup-model-configuration-1"><a class="docs-heading-anchor" href="#Setup-model-configuration-1">Setup model configuration</a><a class="docs-heading-anchor-permalink" href="#Setup-model-configuration-1" title="Permalink"></a></h2><ol><li>define a reference <code>ref_state</code></li></ol><p>This reference state both improves numerical stability of the implicit time stepper and enables a faster model spin-up. (and  buoyancy calculation?) It assumes hydrostatic balance and ideal gas law, with a pressure <span>$p_r(z)$</span> and density <span>$\rho_r(z)$</span> that only depend on altitude <span>$z$</span> and are in hydrostatic balance. The temperature reference profile linearly increases with height until <span>$T_{\\text{min}}$</span> is reached.</p><ol><li>set up a Rayleigh sponge layer</li></ol><p>To avoid wave reflection at the top of the domain, the model applies a sponge layer that linearly damps the momentum equations.</p><ol><li>Instantiate the model using the Held Suarez setup</li></ol><p>The Held Suarez setup was designed to produce an equilibrated state that is comparable to the zonal mean of the Earth’s atmosphere. This forcing setting, called by <code>held_suarez_forcing!</code> follows exactly the Held and Suarez (1994) paper.</p><ol><li>get the driver configuration (<code>src/Drivers/driver_config.jl</code>)</li></ol><pre><code class="language-">function config_heldsuarez(FT, poly_order, resolution)
    # 1. set up reference state
    T_sfc::FT = 290 ## surface temperature of reference state (K)
    ΔT::FT = 60     ## temperature drop between surface and top of atmosphere (K)
    H_t::FT = 8e3   ## height scale over which temperature drops (m)
    temp_profile_ref = DecayingTemperatureProfile(T_sfc, ΔT, H_t)
    ref_state = HydrostaticState(temp_profile_ref, FT(0))

    # 2. set up a Rayleigh sponge
    domain_height::FT = 30e3               ## distance between surface and top of atmosphere (m)
    z_sponge::FT = 12e3                    ## height at which sponge begins (m)
    α_relax::FT = 1 / 60 / 15              ## sponge relaxation rate (1/s)
    exp_sponge = 2                         ## sponge exponent for squared-sinusoid profile
    u_relax = SVector(FT(0), FT(0), FT(0)) # relaxation velocity (m/s)
    ## get sponge structure (defined in src/Atmos/Model/source.jl)
    sponge = RayleighSponge{FT}(
        domain_height,
        z_sponge,
        α_relax,
        u_relax,
        exp_sponge,
    )

    # 3. instantiate the model
    model = AtmosModel{FT}(
        AtmosGCMConfigType,
        param_set;
        ref_state = ref_state,
        turbulence = SmagorinskyLilly(c_smag = 0.21),
        hyperdiffusion = StandardHyperDiffusion(τ_hyper = 4 * 3600),
        moisture = DryModel(),
        source = (Gravity(), Coriolis(), held_suarez_forcing!, sponge),
        init_state = init_heldsuarez!,
    )</code></pre><ol><li>get the driver configuration</li></ol><pre><code class="language-">    config = CLIMA.AtmosGCMConfiguration(
        exp_name = &quot;HeldSuarez&quot;,
        poly_order,
        resolution,
        domain_height,
        param_set,
        init_heldsuarez!;
        model = model,
    )

    return config
end</code></pre><p>Construct the Held-Suarez forcing function</p><pre><code class="language-julia">function held_suarez_forcing!(
    bl,
    source,
    state,
    diffusive,
    aux,
    t::Real,
    direction,
)
    FT = eltype(state)

    # Parameters
    T_ref::FT = 255        # reference temperature for Held-Suarez forcing (K)

    # Extract the state
    ρ = state.ρ
    ρu = state.ρu
    ρe = state.ρe

    coord = aux.coord
    e_int = internal_energy(bl.moisture, bl.orientation, state, aux)
    T = air_temperature(bl.param_set, e_int)
    _R_d = FT(R_d(bl.param_set))
    _day = FT(day(bl.param_set))
    _grav = FT(grav(bl.param_set))
    _cp_d = FT(cp_d(bl.param_set))
    _cv_d = FT(cv_d(bl.param_set))

    # Held-Suarez parameters
    k_a = FT(1 / (40 * _day))
    k_f = FT(1 / _day)
    k_s = FT(1 / (4 * _day))
    ΔT_y = FT(60)
    Δθ_z = FT(10)
    T_equator = FT(315)
    T_min = FT(200)
    σ_b = FT(7 / 10)

    # Held-Suarez forcing
    φ = latitude(bl.orientation, aux)
    p = air_pressure(bl.param_set, T, ρ)

    ##TODO: replace _p0 with dynamic surfce pressure in Δσ calculations to account
    #for topography, but leave unchanged for calculations of σ involved in T_equil
    _p0 = 1.01325e5
    σ = p / _p0
    exner_p = σ^(_R_d / _cp_d)
    Δσ = (σ - σ_b) / (1 - σ_b)
    height_factor = max(0, Δσ)
    T_equil = (T_equator - ΔT_y * sin(φ)^2 - Δθ_z * log(σ) * cos(φ)^2) * exner_p
    T_equil = max(T_min, T_equil)
    k_T = k_a + (k_s - k_a) * height_factor * cos(φ)^4
    k_v = k_f * height_factor

    # Apply Held-Suarez forcing
    source.ρu -= k_v * projection_tangential(bl, aux, ρu)
    source.ρe -= k_T * ρ * _cv_d * (T - T_equil)
    return nothing
end</code></pre><pre><code class="language-none">held_suarez_forcing! (generic function with 1 method)</code></pre><h2 id="Set-initial-condition.-1"><a class="docs-heading-anchor" href="#Set-initial-condition.-1">Set initial condition.</a><a class="docs-heading-anchor-permalink" href="#Set-initial-condition.-1" title="Permalink"></a></h2><p>Zero initial velocity and thermal reference state.</p><pre><code class="language-">function init_heldsuarez!(bl, state, aux, coords, t)
    FT = eltype(state)</code></pre><p>Set initial state to reference state with random perturbation</p><pre><code class="language-">    rnd = FT(1.0 + rand(Uniform(-1e-3, 1e-3)))
    state.ρ = aux.ref_state.ρ
    state.ρu = SVector{3, FT}(0, 0, 0)
    state.ρe = rnd * aux.ref_state.ρe

    nothing
end</code></pre><h2 id="Setup-diagnostic-output-1"><a class="docs-heading-anchor" href="#Setup-diagnostic-output-1">Setup diagnostic output</a><a class="docs-heading-anchor-permalink" href="#Setup-diagnostic-output-1" title="Permalink"></a></h2><p>Choose frequency and resolution of output, and a diagnostics group (dgngrp) which defines output variables. This needs to be defined in <code>src/Diagnostics/</code></p><pre><code class="language-julia">function config_diagnostics(FT, driver_config)
    interval = 1000 ## in time steps

    _planet_radius = FT(planet_radius(param_set))

    info = driver_config.config_info
    boundaries = [
        FT(-90.0) FT(-180.0) _planet_radius
        FT(90.0) FT(180.0) FT(_planet_radius + info.domain_height)
    ]
    resolution = (FT(10), FT(10), FT(1000)) ## in (deg, deg, m)

    # setup interpolation to sphere on required grid
    interpol =
        CLIMA.InterpolationConfiguration(driver_config, boundaries, resolution)

    dgngrp = setup_dump_state_and_aux_diagnostics(
        interval,
        driver_config.name,
        interpol = interpol,
        project = true,
    )
    return CLIMA.DiagnosticsConfiguration([dgngrp])
end</code></pre><pre><code class="language-none">config_diagnostics (generic function with 1 method)</code></pre><h2 id="Set-up-and-run-the-simulation-1"><a class="docs-heading-anchor" href="#Set-up-and-run-the-simulation-1">Set up and run the simulation</a><a class="docs-heading-anchor-permalink" href="#Set-up-and-run-the-simulation-1" title="Permalink"></a></h2><p>Initiate CLIMA, set up experiment-specific (driver<em>config) time-stepping (solver</em>config) and output (dgn_config) configurations, set up spectral filter for DG calculation, and run the model.</p><pre><code class="language-">function main()
    # initiate CLIMA using ```init()``` from ```src/Drivers/Driver.jl```
    CLIMA.init()

    # Driver configuration parameters
    FT = Float32                             ## floating type precision
    poly_order = 5                           ## discontinuous Galerkin polynomial order
    n_horz = 5                               ## horizontal element number
    n_vert = 5                               ## vertical element number
    n_days = 120                             ## experiment day number
    timestart = FT(0)                        ## start time (s)
    timeend = FT(n_days * day(param_set))    ## end time (s)

    # Set up driver configuration
    driver_config = config_heldsuarez(FT, poly_order, (n_horz, n_vert))

    # Set up experiment
    solver_config = CLIMA.SolverConfiguration(
        timestart,
        timeend,
        driver_config,
        Courant_number = 0.2,
        init_on_cpu = true,
        CFL_direction = HorizontalDirection(),
        diffdir = HorizontalDirection(),
    )

    # Set up diagnostics
    dgn_config = config_diagnostics(FT, driver_config)

    # Set up exponential filter
    filterorder = 10
    filter = ExponentialFilter(solver_config.dg.grid, 0, filterorder)
    cbfilter = GenericCallbacks.EveryXSimulationSteps(1) do
        Filters.apply!(
            solver_config.Q,
            1:size(solver_config.Q, 2),
            solver_config.dg.grid,
            filter,
        )
        nothing
    end

    # Run the model using ```invoke!``` from ```src/Drivers/Driver.jl```
    result = CLIMA.invoke!(
        solver_config;
        diagnostics_config = dgn_config,
        user_callbacks = (cbfilter,),
        check_euclidean_distance = true,
    )
end

main() # hide</code></pre><h2 id="Visualize-(nc-files-in-julia?)-1"><a class="docs-heading-anchor" href="#Visualize-(nc-files-in-julia?)-1">Visualize (nc files in julia?)</a><a class="docs-heading-anchor-permalink" href="#Visualize-(nc-files-in-julia?)-1" title="Permalink"></a></h2><h2 id="References-1"><a class="docs-heading-anchor" href="#References-1">References</a><a class="docs-heading-anchor-permalink" href="#References-1" title="Permalink"></a></h2><ul><li>Held, I.M. and M.J. Suarez, 1994: A Proposal for the Intercomparison</li></ul><p>the Dynamical Cores of Atmospheric General Circulation Models. Bull. # Amer. Meteor. Soc., 75, 1825–1830, https://doi.org/10.1175/1520-0477(1994)075&lt;1825:APFTIO&gt;2.0.CO;2</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../literate_markdown/">« Notes on Literate</a><a class="docs-footer-nextpage" href="../../ContributionGuides/CONTRIBUTING/">Contributing »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 22 April 2020 01:24">Wednesday 22 April 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
